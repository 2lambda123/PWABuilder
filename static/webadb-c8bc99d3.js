var e={};!function(){e.Opt={},e.Opt.debug=!1,e.Opt.dump=!1,e.Opt.key_size=2048,e.Opt.reuse_key=-1,e.Opt.use_checksum=!0;let t=function(){let t=window.indexedDB.open("WebADB",1);return t.onupgradeneeded=function(t){let n=t.target.result;e.Opt.debug,n.objectStoreNames.contains("keys")&&(e.Opt.debug,n.deleteObjectStore("keys")),n.createObjectStore("keys",{autoIncrement:!0})},b(t)}(),n=t.then((function(t){let n=t.transaction("keys"),r=n.objectStore("keys").openCursor(),i=[];return r.onsuccess=function(e){let t=e.target.result;null!=t&&(i.push(t.value),t.continue())},b(n,"oncomplete").then((function(t){return e.Opt.debug,i}))}));e.open=function(t){if("WebUSB"==t)return e.WebUSB.Transport.open();throw new Error("Unsupported transport: "+t)},e.WebUSB={},e.WebUSB.Transport=function(t){this.device=t,e.Opt.debug},e.WebUSB.Transport.open=function(){return navigator.usb.requestDevice({filters:[{classCode:255,subclassCode:66,protocolCode:1},{classCode:255,subclassCode:66,protocolCode:3}]}).then(t=>t.open().then(()=>new e.WebUSB.Transport(t)))},e.WebUSB.Transport.prototype.close=function(){this.device.close()},e.WebUSB.Transport.prototype.send=function(t,n){return e.Opt.dump&&d(new DataView(n),t+"==> "),this.device.transferOut(t,n)},e.WebUSB.Transport.prototype.receive=function(t,n){return this.device.transferIn(t,n).then(n=>(e.Opt.dump&&d(n.data,"<=="+t+" "),n.data))},e.WebUSB.Transport.prototype.find=function(e){for(let t in this.device.configurations){let n=this.device.configurations[t];for(let t in n.interfaces){let r=n.interfaces[t];for(let t in r.alternates){let i=r.alternates[t];if(e.classCode==i.interfaceClass&&e.subclassCode==i.interfaceSubclass&&e.protocolCode==i.interfaceProtocol)return{conf:n,intf:r,alt:i}}}}return null},e.WebUSB.Transport.prototype.isAdb=function(){return null!=this.find({classCode:255,subclassCode:66,protocolCode:1})},e.WebUSB.Transport.prototype.isFastboot=function(){return null!=this.find({classCode:255,subclassCode:66,protocolCode:3})},e.WebUSB.Transport.prototype.getDevice=function(e){let t=this.find(e);return this.device.selectConfiguration(t.conf.configurationValue).then(()=>this.device.claimInterface(t.intf.interfaceNumber)).then(()=>this.device.selectAlternateInterface(t.intf.interfaceNumber,t.alt.alternateSetting)).then(()=>t)},e.WebUSB.Transport.prototype.connectAdb=function(r,i=null){let o=0,a=e.Opt.use_checksum?16777216:16777217,s=new e.Message("CNXN",a,262144,r+"\0");return this.getDevice({classCode:255,subclassCode:66,protocolCode:1}).then(t=>new e.WebUSB.Device(this,t)).then(a=>s.send_receive(a).then((function r(s){return"AUTH"!=s.cmd||1!=s.arg0?s:n.then(n=>function(n,r,i,o,a,s){if(i<r.length){let t=r.length-i-1,s=r[t],c=Promise.resolve();return e.Opt.debug,e.Opt.dump&&(c=c.then(()=>f(s)).then(()=>g(s)).then(()=>d(new DataView(o))).then(()=>{})),c.then(()=>crypto.subtle.sign({name:"RSASSA-PKCS1-v1_5"},s.privateKey,o)).then(t=>(e.Opt.dump,new e.Message("AUTH",2,0,t).send_receive(n).then(a)))}let c=null,u=!1;!1!==e.Opt.reuse_key&&((i=!0===e.Opt.reuse_key?-1:e.Opt.reuse_key)<0&&(i+=r.length),i>=0&&i<r.length&&(e.Opt.debug,c=Promise.resolve(r[i])));null===c&&(e.Opt.debug,c=function(){let t=e.Opt.dump;return crypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:e.Opt.key_size,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-1"}},t,["sign","verify"]).then(t=>e.Opt.dump?f(t).then(()=>g(t)).then(()=>t):t)}(),u=!0);return c.then(i=>crypto.subtle.exportKey("spki",i.publicKey).then(t=>new e.Message("AUTH",3,0,btoa(new Uint8Array(t).reduce((e,t)=>e+String.fromCharCode(t),""))+"\0").send(n)).then(()=>(e.Opt.debug,null!=s&&s(i.publicKey),e.Message.receive(n))).then(n=>"CNXN"!=n.cmd?n:u?(r.push(i),t.then(t=>function(t,n){return b(t.transaction("keys","readwrite").objectStore("keys").put(n)).then((function(t){return e.Opt.debug,t}))}(t,i)).then(()=>n)):n))}(a,n,o++,s.data.buffer,r,i))})).then(t=>{if("CNXN"!=t.cmd)throw new Error("Failed to connect with '"+r+"'");if(16777216!=t.arg0&&16777217!=t.arg0)throw new Error("Version mismatch: "+t.arg0+" (expected: 16777216 or 16777217)");return e.Opt.debug,a.max_payload=t.arg1,16777217==t.arg0&&(e.Opt.use_checksum=!1),a}))},e.WebUSB.Transport.prototype.connectFastboot=function(){return this.getDevice({classCode:255,subclassCode:66,protocolCode:3}).then(e=>new r.WebUSB.Device(this,e)).then(e=>e.send("getvar:max-download-size").then(()=>e.receive().then(t=>{if("FAIL"==p(t.getUint32(0,!0)))throw new Error("Unable to open Fastboot");return e.get_cmd=e=>p(e.getUint32(0,!0)),e.get_payload=e=>e.buffer.slice(4),e})))},e.WebUSB.Device=function(e,t){this.transport=e,this.max_payload=4096,this.ep_in=h(t.alt.endpoints,"in"),this.ep_out=h(t.alt.endpoints,"out")},e.WebUSB.Device.prototype.open=function(t){return e.Stream.open(this,t)},e.WebUSB.Device.prototype.shell=function(t){return e.Stream.open(this,"shell:"+t)},e.WebUSB.Device.prototype.tcpip=function(t){return e.Stream.open(this,"tcpip:"+t)},e.WebUSB.Device.prototype.sync=function(){return e.Stream.open(this,"sync:")},e.WebUSB.Device.prototype.reboot=function(t=""){return e.Stream.open(this,"reboot:"+t)},e.WebUSB.Device.prototype.send=function(e){if("string"==typeof e){let t=e;e=(new TextEncoder).encode(t).buffer}if(null!=e&&e.length>this.max_payload)throw new Error("data is too big: "+e.length+" bytes (max: "+this.max_payload+" bytes)");return this.transport.send(this.ep_out,e)},e.WebUSB.Device.prototype.receive=function(e){return this.transport.receive(this.ep_in,e)};let r={WebUSB:{}};r.WebUSB.Device=function(e,t){this.transport=e,this.max_datasize=64,this.ep_in=h(t.alt.endpoints,"in"),this.ep_out=h(t.alt.endpoints,"out")},r.WebUSB.Device.prototype.send=function(e){if("string"==typeof e){let t=e;e=(new TextEncoder).encode(t).buffer}if(null!=e&&e.length>this.max_datasize)throw new Error("data is too big: "+e.length+" bytes (max: "+this.max_datasize+" bytes)");return this.transport.send(this.ep_out,e)},r.WebUSB.Device.prototype.receive=function(){return this.transport.receive(this.ep_in,64)},e.Message=function(e,t,n,r=null){if(4!=e.length)throw new Error("Invalid command: '"+e+"'");this.cmd=e,this.arg0=t,this.arg1=n,this.length=null===r?0:"string"==typeof r?r.length:r.byteLength,this.data=r},e.Message.checksum=function(e){let t=0;for(let n=0;n<e.byteLength;n++)t+=e.getUint8(n);return 4294967295&t},e.Message.send=function(t,n){let r=new ArrayBuffer(24),i=l(n.cmd),o=4294967295^i,a=null,s=0,c=0;if(e.Opt.debug,null!=n.data){if("string"==typeof n.data){let e=new TextEncoder;a=e.encode(n.data).buffer}else a=ArrayBuffer.isView(n.data)?n.data.buffer:n.data;if(s=a.byteLength,e.Opt.use_checksum&&(c=e.Message.checksum(new DataView(a))),s>t.max_payload)throw new Error("data is too big: "+s+" bytes (max: "+t.max_payload+" bytes)")}let u=new DataView(r);u.setUint32(0,i,!0),u.setUint32(4,n.arg0,!0),u.setUint32(8,n.arg1,!0),u.setUint32(12,s,!0),u.setUint32(16,c,!0),u.setUint32(20,o,!0);let d=t.send(r);return s>0&&d.then(()=>t.send(a)),d},e.Message.receive=function(t){return t.receive(24).then(n=>{let r=n.getUint32(0,!0),i=n.getUint32(4,!0),o=n.getUint32(8,!0),a=n.getUint32(12,!0),s=n.getUint32(16,!0);if(e.use_checksum&&n.byteLength>20){let e=n.getUint32(20,!0);if(-1!=(r^e))throw new Error("magic mismatch")}if(r=p(r),0==a){let t=new e.Message(r,i,o);return e.Opt.debug,t}return t.receive(a).then(t=>{if(e.Opt.use_checksum&&e.Message.checksum(t)!=s)throw new Error("checksum mismatch");let n=new e.Message(r,i,o,t);return e.Opt.debug,n})})},e.Message.prototype.send=function(t){return e.Message.send(t,this)},e.Message.prototype.send_receive=function(t){return this.send(t).then(()=>e.Message.receive(t))},e.SyncFrame=function(e,t=0,n=null){if(4!=e.length)throw new Error("Invalid command: '"+e+"'");this.cmd=e,this.length=t,this.data=n},e.SyncFrame.send=function(t,n){let r=new ArrayBuffer(8),i=l(n.cmd);e.Opt.debug;let o=new DataView(r);return o.setUint32(0,i,!0),o.setUint32(4,n.length,!0),t.send("WRTE",r)},e.SyncFrame.receive=function(t){return t.receive().then(n=>{if("WRTE"==n.cmd){let r=p(n.data.getUint32(0,!0));if("OKAY"==r||"DATA"==r||"DONE"==r||"FAIL"==r){let i=n.data.getUint32(4,!0),o=new DataView(n.data.buffer.slice(8));if(0==i||o.byteLength>=i){let t=new e.SyncFrame(r,i,o);return e.Opt.debug,t}return t.send("OKAY").then(()=>t.receive()).then(t=>{if(null==t.data){let t=new e.SyncFrame(r);return e.Opt.debug,t}let n=p(t.data.getUint32(0,!0));if("OKAY"==n||"DATA"==n||"DONE"==n||"FAIL"==n){let r=t.data.getUint32(4,!0),i=new DataView(t.data.buffer.slice(8));if(0==r||i.byteLength>=r){let t=new e.SyncFrame(n,r,i);return e.Opt.debug,t}}if(t.data.byteLength<i)throw new Error("expected at least "+i+", got "+t.data.byteLength);let o=new e.SyncFrame(r,i,t.data);return e.Opt.debug,o})}throw e.Opt.debug,e.Opt.dump&&d(n.data,"WRTE: "),new Error("invalid WRTE frame")}if("OKAY"==n.cmd){let t=new e.SyncFrame("OKAY");return e.Opt.debug,t}throw e.Opt.debug,new Error("invalid SYNC frame")})},e.SyncFrame.prototype.send=function(t){return e.SyncFrame.send(t,this)},e.SyncFrame.prototype.send_receive=function(t){return e.SyncFrame.send(t,this).then(()=>e.SyncFrame.receive(t))},e.Stream=function(e,t,n,r){this.device=e,this.service=t,this.local_id=n,this.remote_id=r,this.cancel=null};let i=1;function o(e,t){return function(n){if("FAIL"==n.cmd){let e=new TextDecoder;throw new Error(e.decode(n.data))}if(n.cmd!=e)throw new Error(t);return n}}function a(e){return o("OKAY",e)}function s(e,t,n){let r=t-e.length,i="";for(let e=0;e<r;e++)i+=n;return i+e}function c(e){return s(e.toString(16),2,"0")}function u(e){return s(e.toString(16),8,"0")}function d(e,t=""){let n=new TextDecoder;for(let r=0;r<e.byteLength;r+=16){let i,o=e.byteLength-r>16?16:e.byteLength-r,a=t+s(r.toString(16),4,"0")+" ";for(i=0;i<o;i++)a+=" "+c(e.getUint8(r+i));for(;i<16;i++)a+="   ";a+=" | "+n.decode(new DataView(e.buffer,r,o))}}function h(t,n,r="bulk"){let i,o;for(i in t)if(o=t[i],o.direction==n&&o.type==r)return o.endpointNumber;throw e.Opt.debug,new Error("Cannot find "+n+" endpoint")}function l(e){let t=(new TextEncoder).encode(e).buffer;return new DataView(t).getUint32(0,!0)}function p(e){let t=new TextDecoder,n=new ArrayBuffer(4);return new DataView(n).setUint32(0,e,!0),t.decode(n)}function f(e){if(e.privateKey.extractable)return crypto.subtle.exportKey("pkcs8",e.privateKey).then(e=>{})}function g(e){if(e.publicKey.extractable)return crypto.subtle.exportKey("spki",e.publicKey).then(e=>{})}function b(e,t="onsuccess",n="onerror"){return new Promise((function(r,i){e[t]=e=>r(e.target.result),e[n]=e=>i(e.target.errorCode)}))}e.Stream.open=function(t,n){let r=i++,o=0;return new e.Message("OPEN",r,o,n+"\0").send_receive(t).then((function i(a){if(a.arg1!=r)return e.Message.receive(t).then(i);if("OKAY"!=a.cmd)throw new Error("Open failed");return o=a.arg0,e.Opt.debug,new e.Stream(t,n,r,o)}))},e.Stream.prototype.close=function(){if(0!=this.local_id)return this.local_id=0,this.send("CLSE");e.Opt.debug,this.service="",this.remote_id=0},e.Stream.prototype.send=function(t,n=null){return new e.Message(t,this.local_id,this.remote_id,n).send(this.device)},e.Stream.prototype.receive=function(){return e.Message.receive(this.device).then(e=>{if(0!=e.arg0&&e.arg0!=this.remote_id)throw new Error("Incorrect arg0: 0x"+u(e.arg0)+" (expected 0x"+u(this.remote_id)+")");if(0!=this.local_id&&e.arg1!=this.local_id)throw new Error("Incorrect arg1: 0x"+u(e.arg1)+" (expected 0x"+u(this.local_id)+")");return e})},e.Stream.prototype.send_receive=function(e,t=null){return this.send(e,t).then(()=>this.receive())},e.Stream.prototype.abort=function(){e.Opt.debug;let t=this;return new Promise((function(n,r){t.cancel=function(){e.Opt.debug,t.cancel=null,n()}}))},e.Stream.prototype.stat=function(t){return new e.SyncFrame("STAT",t.length).send_receive(this).then(a("STAT failed on "+t)).then(e=>{let n=new TextEncoder;return this.send_receive("WRTE",n.encode(t))}).then(a("STAT failed on "+t)).then(e=>this.receive().then(e=>this.send("OKAY").then(()=>e.data))).then(n=>{let r=p(n.getUint32(0,!0)),i=n.getUint32(4,!0),o=n.getUint32(8,!0),a=n.getUint32(12,!0);if(e.Opt.debug,"STAT"!=r)throw new Error("STAT failed on "+t);return{mode:i,size:o,time:a}})},e.Stream.prototype.pull=function(t){return new e.SyncFrame("RECV",t.length).send_receive(this).then(a("PULL RECV failed on "+t)).then(e=>{let n=new TextEncoder;return this.send_receive("WRTE",n.encode(t))}).then(a("PULL WRTE failed on "+t)).then(()=>e.SyncFrame.receive(this)).then(o("DATA","PULL DATA failed on "+t)).catch(e=>this.send("OKAY").then(()=>{throw e})).then(e=>this.send("OKAY").then(()=>e)).then(e=>{let n=e.length;if(e.data.byteLength==n+8){let r=e.data.getUint32(n,!0),i=e.data.getUint32(n+4,!0);if("DONE"!=p(r)||0!=i)throw new Error("PULL DONE failed on "+t);return new DataView(e.data.buffer,0,n)}if(e.data.byteLength>65536){let n=e.data.getUint32(e.data.byteLength-8,!0),r=e.data.getUint32(e.data.byteLength-4,!0);if("DONE"!=p(n)||0!=r)throw new Error("PULL DONE failed on "+t);return new DataView(e.data.buffer,0,e.data.byteLength-8)}if(e.data.byteLength!=n)throw new Error("PULL DATA failed on "+t+": "+e.data.byteLength+"!="+n);return this.receive().then(e=>{let n=e.data.getUint32(0,!0),r=e.data.getUint32(4,!0);if("DONE"!=p(n)||0!=r)throw new Error("PULL DONE failed on "+t)}).then(()=>this.send("OKAY")).then(()=>e.data)})},e.Stream.prototype.push_start=function(t,n){let r=n.toString(10),i=new TextEncoder;return new e.SyncFrame("SEND",t.length+1+r.length).send_receive(this).then(a("PUSH failed on "+t)).then(e=>this.send("WRTE",i.encode(t))).then(()=>e.SyncFrame.receive(this)).then(a("PUSH failed on "+t)).then(e=>this.send("WRTE",i.encode(","+r))).then(()=>e.SyncFrame.receive(this)).then(a("PUSH failed on "+t))},e.Stream.prototype.push_data=function(t){if("string"==typeof t){let e=new TextEncoder,n=t;t=e.encode(n).buffer}else ArrayBuffer.isView(t)&&(t=t.buffer);return new e.SyncFrame("DATA",t.byteLength).send_receive(this).then(a("PUSH failed")).then(e=>this.send("WRTE",t)).then(()=>e.SyncFrame.receive(this)).then(a("PUSH failed"))},e.Stream.prototype.push_done=function(){return new e.SyncFrame("DONE",Math.round(Date.now()/1e3)).send_receive(this).then(a("PUSH failed")).then(t=>e.SyncFrame.receive(this)).then(a("PUSH failed")).then(e=>this.send("OKAY"))},e.Stream.prototype.push=function(t,n,r,i=null){let o=e.Opt.debug,a=e.Opt.dump;return e.Opt.debug=!1,e.Opt.dump=!1,(s=t,new Promise((function(e,t){let n=new FileReader;n.onload=t=>e(t.target.result),n.onerror=e=>t(e.target.error),n.readAsArrayBuffer(s)}))).then(s=>this.push_start(n,r).then(()=>{let n=Promise.resolve(),r=t.size,c=Math.min(65536,this.device.max_payload);for(;r>0;){let u=Math.min(r,c),d=t.size-r;n=n.then(()=>{if(this.cancel)throw e.Opt.debug=o,e.Opt.dump=a,this.cancel(),new Error("cancelled");return null!=i&&i(d,t.size),this.push_data(s.slice(d,d+u))}),r-=u}return n.then(()=>(e.Opt.debug=o,e.Opt.dump=a,this.push_done()))}));var s},e.Stream.prototype.quit=function(){return new e.SyncFrame("QUIT").send_receive(this).then(a("QUIT failed")).then(e=>this.receive()).then(o("CLSE","QUIT failed")).then(e=>this.close())}}(),window.Adb=e;export default e;
//# sourceMappingURL=webadb-c8bc99d3.js.map
